<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Stranger Planets</title>
        
        <!-- Meta Tags -->
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="" />
        <meta name="copyright" content="" />
        <meta name="ROBOTS" content="INDEX, FOLLOW" />
        <meta name="creation_Date" content="" />
        
        <!-- Fonts -->
        <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
        <link href="style.css" rel="stylesheet">
        <link rel="stylesheet" href="warp-effect.css">
        
        <!-- Menu Styles -->
        <style>
            :root {
                --neon-cyan: #22d3ee;
                --glow-color: rgba(34, 211, 238, 0.5);
                --glow-color-strong: rgba(34, 211, 238, 0.7);
            }

            .next-planet-btn {
                position: fixed;
                top: 80px;
                left: 20px;
                padding: 12px 24px;
                background: transparent;
                border: 2px solid var(--neon-cyan);
                color: var(--neon-cyan);
                font-family: 'Share Tech Mono', monospace;
                font-size: 1.1rem;
                cursor: pointer;
                transition: all 0.3s ease;
                z-index: 1000;
                border-radius: 4px;
                text-transform: uppercase;
                letter-spacing: 1px;
                backdrop-filter: blur(5px);
            }

            .collections-btn {
                position: fixed;
                top: 140px;
                left: 20px;
                padding: 12px 24px;
                background: transparent;
                border: 2px solid var(--neon-cyan);
                color: var(--neon-cyan);
                font-family: 'Share Tech Mono', monospace;
                font-size: 1.1rem;
                cursor: pointer;
                transition: all 0.3s ease;
                z-index: 1000;
                border-radius: 4px;
                text-transform: uppercase;
                letter-spacing: 1px;
                backdrop-filter: blur(5px);
            }

            .settings-btn {
                position: fixed;
                top: 20px;
                left: 20px;
                width: 40px;
                height: 40px;
                background: transparent;
                border: 2px solid var(--neon-cyan);
                color: var(--neon-cyan);
                cursor: pointer;
                transition: all 0.3s ease;
                z-index: 1000;
                border-radius: 4px;
                backdrop-filter: blur(5px);
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                gap: 5px;
            }

            .settings-btn span {
                display: block;
                width: 20px;
                height: 2px;
                background-color: var(--neon-cyan);
                transition: all 0.3s ease;
            }

            .settings-btn:hover {
                background: var(--neon-cyan);
            }

            .settings-btn:hover span {
                background-color: #000;
            }

            .settings-modal {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                backdrop-filter: blur(5px);
                z-index: 5000;
                display: none;
                justify-content: center;
                align-items: center;
            }

            .settings-content {
                background: linear-gradient(45deg, #000000, #1a1a2e);
                border: 2px solid var(--neon-cyan);
                border-radius: 8px;
                padding: 40px;
                max-width: 500px;
                width: 90%;
                position: relative;
                color: var(--neon-cyan);
            }

            .settings-content h2 {
                margin-top: 0;
                font-size: 1.5rem;
                margin-bottom: 20px;
            }

            .close-settings {
                position: absolute;
                top: 15px;
                right: 15px;
                background: none;
                border: none;
                color: var(--neon-cyan);
                font-size: 1.5rem;
                cursor: pointer;
                transition: all 0.3s ease;
            }

            .close-settings:hover {
                color: #fff;
                text-shadow: 0 0 10px var(--neon-cyan);
            }

            .next-planet-btn:hover {
                background: var(--neon-cyan);
                color: #000;
                box-shadow: 0 0 20px var(--glow-color);
            }

            .collections-btn:hover {
                background: var(--neon-cyan);
                color: #000;
                box-shadow: 0 0 20px var(--glow-color);
            }

            .next-planet-btn::before {
                content: 'â¯ˆ';
                margin-right: 8px;
                font-size: 0.9em;
            }

            @keyframes space-float {
                0% { transform: translate(0, 0); }
                50% { transform: translate(-10px, -10px); }
                100% { transform: translate(0, 0); }
            }

            @keyframes nebula-pulse {
                0% { opacity: 0.5; }
                50% { opacity: 0.8; }
                100% { opacity: 0.5; }
            }

            @keyframes star-twinkle {
                0%, 100% { opacity: 1; }
                50% { opacity: 0.3; }
            }

            #main-menu {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(to bottom, 
                    #000000,
                    #0a0a2a,
                    #1a1a3a,
                    #0a0a2a,
                    #000000
                );
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 3000;
                color: var(--neon-cyan);
                text-align: center;
                transition: opacity 0.5s ease;
                overflow: hidden;
            }

            #main-menu::before {
                content: '';
                position: absolute;
                width: 200%;
                height: 200%;
                top: -50%;
                left: -50%;
                background-image: 
                    radial-gradient(1px 1px at 25px 25px, white 1px, transparent 1px),
                    radial-gradient(2px 2px at 50px 50px, white 1px, transparent 1px),
                    radial-gradient(1px 1px at 75px 75px, white 1px, transparent 1px),
                    radial-gradient(2px 2px at 100px 100px, white 1px, transparent 1px);
                background-size: 100px 100px;
                animation: space-float 80s linear infinite;
                opacity: 0.5;
            }

            #main-menu::after {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: 
                    radial-gradient(circle at 20% 30%, rgba(64, 0, 128, 0.3) 0%, transparent 50%),
                    radial-gradient(circle at 80% 20%, rgba(0, 128, 128, 0.3) 0%, transparent 50%),
                    radial-gradient(circle at 50% 50%, rgba(128, 0, 64, 0.2) 0%, transparent 60%),
                    radial-gradient(circle at 30% 70%, rgba(0, 64, 128, 0.3) 0%, transparent 50%);
                animation: nebula-pulse 8s ease-in-out infinite;
                z-index: -1;
            }

            .geometric-overlay {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background:
                    linear-gradient(45deg, transparent 49%, rgba(34, 211, 238, 0.03) 50%, transparent 51%),
                    linear-gradient(-45deg, transparent 49%, rgba(0, 255, 153, 0.02) 50%, transparent 51%);
                background-size: 60px 60px;
                z-index: -1;
                animation: geometricShift 15s ease-in-out infinite;
            }

            #main-menu.hidden {
                opacity: 0;
                pointer-events: none;
            }

            .menu-content {
                z-index: 10;
                position: relative;
            }

            .title {
                font-size: clamp(2rem, 8vw, 5rem);
                margin-bottom: 3rem;
                color: var(--neon-cyan);
                text-shadow: 
                    0 0 10px var(--glow-color-strong),
                    0 0 20px var(--glow-color),
                    0 0 40px var(--glow-color);
                letter-spacing: 2px;
                animation: title-glow 3s ease-in-out infinite;
            }

            @keyframes title-glow {
                0%, 100% { text-shadow: 0 0 10px var(--glow-color-strong), 0 0 20px var(--glow-color), 0 0 40px var(--glow-color); }
                50% { text-shadow: 0 0 15px var(--glow-color-strong), 0 0 30px var(--glow-color), 0 0 60px var(--glow-color); }
            }

            .menu-button {
                background: transparent;
                border: 2px solid var(--neon-cyan);
                color: var(--neon-cyan);
                padding: 15px 40px;
                font-family: 'Share Tech Mono', monospace;
                font-size: 1.5rem;
                cursor: pointer;
                transition: all 0.3s ease;
                margin: 10px;
                min-width: 200px;
                display: inline-block;
                border-radius: 4px;
            }

            .menu-button:hover {
                background: var(--neon-cyan);
                color: #000;
                box-shadow: 0 0 20px var(--glow-color);
            }

            @keyframes geometricShift {
                0%, 100% { transform: translateX(0) translateY(0); }
                50% { transform: translateX(30px) translateY(-30px); }
            }

            /* Collections removed */
        </style>

        <!-- Meta Description  -->
        <meta name="description" content="" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

        <!-- Favicon  -->
        <link rel="apple-touch-icon" sizes="57x57" href="./src/assets/img/ico/apple-icon-57x57.png">
        <link rel="apple-touch-icon" sizes="60x60" href="./src/assets/img/ico/apple-icon-60x60.png">
        <link rel="apple-touch-icon" sizes="72x72" href="./src/assets/img/ico/apple-icon-72x72.png">
        <link rel="apple-touch-icon" sizes="76x76" href="./src/assets/img/ico/apple-icon-76x76.png">
        <link rel="apple-touch-icon" sizes="114x114" href="./src/assets/img/ico/apple-icon-114x114.png">
        <link rel="apple-touch-icon" sizes="120x120" href="./src/assets/img/ico/apple-icon-120x120.png">
        <link rel="apple-touch-icon" sizes="144x144" href="./src/assets/img/ico/apple-icon-144x144.png">
        <link rel="apple-touch-icon" sizes="152x152" href="./src/assets/img/ico/apple-icon-152x152.png">
        <link rel="apple-touch-icon" sizes="180x180" href="./src/assets/img/ico/apple-icon-180x180.png">
        <link rel="icon" type="image/png" sizes="192x192"  href="./src/assets/img/ico/android-icon-192x192.png">
        <link rel="icon" type="image/png" sizes="32x32" href="./src/assets/img/ico/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="96x96" href="./src/assets/img/ico/favicon-96x96.png">
        <link rel="icon" type="image/png" sizes="16x16" href="./src/assets/img/ico/favicon-16x16.png">
        <meta name="msapplication-TileColor" content="#000000">
        <meta name="msapplication-TileImage" content="./src/assets/img/ico/ms-icon-144x144.png">
        <meta name="theme-color" content="#000000">

        <!-- Meta Social Sharing  -->
        <!-- Twitter Card data -->
        <meta name="twitter:card" content="summary">
        <meta name="twitter:site" content="@account">
        <meta name="twitter:title" content="Title">
        <meta name="twitter:description" content="Description">
        <meta name="twitter:creator" content="@cmacmillanmarin">
        <meta name="twitter:image" content="./src/assets/img/share/share_twitter.jpg">

        <!-- Open Graph (Fb, G+, Pin..) data -->
        <meta property="og:title" content="Title" />
        <meta property="og:type" content="article" />
        <meta property="og:url" content="" />
        <meta property="og:image" content="./src/assets/img/share/share_facebook.jpg" />
        <meta property="og:description" content="Description" />
        <meta property="og:site_name" content="Sitename" />
        <meta property="fb:admins" content="0000000000" />

        <!--[if IE]>
            <script type="text/javascript">
                 var console = { log: function() {} };
            </script>
        <![endif]-->

    </head>

    <body>
    <div id="planetNameContainer" style="position: fixed; top: 24px; left: 50%; transform: translateX(-50%); z-index: 2000; display: flex; flex-direction: column; align-items: center; pointer-events: none;">
  <div id="planetNameTop" style="color: var(--neon-cyan, #00ffff); font-family: 'Share Tech Mono', monospace; font-size: 1.2rem; letter-spacing: 2px; text-shadow: 0 0 8px #00fff9, 0 0 2px #00fff9; white-space: nowrap; overflow: visible; text-align: center;"></div>
</div>
    <div id="alien-chat-box">
      <div id="alien-chat-drag" title="Drag to move"></div>
      <div id="alien-chat-messages"></div>
      <div id="alien-chat-input-row">
        <input id="alien-chat-input" type="text" placeholder="Say something to the aliens..." maxlength="512" autocomplete="off" />
        <button id="alien-chat-send">Send</button>
      </div>
      <div id="alien-chat-resizer" title="Drag to resize"></div>
    </div>
    
        <button id="next-planet" class="next-planet-btn" style="float: right;">Next Planet</button>
        <button id="settings-btn" class="settings-btn">
            <span></span>
            <span></span>
            <span></span>
        </button>

        <!-- Collections modal removed -->

        <div id="settings-modal" class="settings-modal">
            <div class="settings-content">
                <h2>Settings</h2>
                <button class="close-settings" id="close-settings">&times;</button>
                <div id="settings-options">
                    <div class="graphics-section">
                        <button id="graphics-toggle" class="graphics-toggle-btn">
                            <span id="graphics-arrow" class="arrow">&#9654;</span> Graphics
                        </button>
                        <div class="resolution-options" id="graphics-options" style="display: none;">
                            <label><input type="radio" name="resolution" value="256"> Low</label>
                            <label><input type="radio" name="resolution" value="512"> Medium</label>
                            <label><input type="radio" name="resolution" value="1024" checked> High</label>
                            <label><input type="radio" name="resolution" value="2048"> Ultra</label>
                            <label><input type="radio" name="resolution" value="4096"> 4K</label>
                        </div>
                    </div>
                    <div class="audio-section">
                        <label for="volume-slider" class="section-label">Volume</label>
                        <div class="volume-row">
                            <input type="range" id="volume-slider" min="0" max="100" step="1" />
                            <span id="volume-value">25%</span>
                        </div>
                    </div>
                    <!-- Collections save section removed -->
                </div>
            </div>
        </div>

        <script>
            // Settings modal functionality
            const settingsBtn = document.getElementById('settings-btn');
            const settingsModal = document.getElementById('settings-modal');
            const closeSettings = document.getElementById('close-settings');
            // Collections removed

            settingsBtn.addEventListener('click', () => {
                settingsModal.style.display = 'flex';
                // Attach event listeners for resolution radios each time modal opens
                attachResolutionListeners();
                // Sync volume UI each time modal opens
                if (typeof syncVolumeUI === 'function') syncVolumeUI();
            });

            // Collections feature removed

            // Graphics dropdown logic
            const graphicsToggle = document.getElementById('graphics-toggle');
            const graphicsOptions = document.getElementById('graphics-options');
            const graphicsArrow = document.getElementById('graphics-arrow');
            graphicsToggle.addEventListener('click', () => {
                const isOpen = graphicsOptions.style.display === 'block';
                graphicsOptions.style.display = isOpen ? 'none' : 'block';
                graphicsArrow.innerHTML = isOpen ? '&#9654;' : '&#9660;';
                if (!isOpen) {
                    // Attach listeners when opening
                    attachResolutionListeners();
                }
            });

            // Volume slider logic
            const volumeSlider = document.getElementById('volume-slider');
            const volumeValue = document.getElementById('volume-value');
            function syncVolumeUI() {
                let v = 25;
                if (window.musicAudio && typeof window.musicAudio.volume === 'number') {
                    v = Math.round(window.musicAudio.volume * 100);
                } else {
                    const saved = parseFloat(localStorage.getItem('gameVolume'));
                    if (!isNaN(saved)) v = Math.round(saved * 100);
                }
                volumeSlider.value = String(v);
                volumeValue.textContent = v + '%';
            }
            if (volumeSlider) {
                volumeSlider.addEventListener('input', function() {
                    const v = Math.max(0, Math.min(100, parseInt(this.value || '0', 10)));
                    if (window.musicAudio) {
                        window.musicAudio.volume = v / 100;
                    }
                    localStorage.setItem('gameVolume', String(v / 100));
                    volumeValue.textContent = v + '%';
                });
            }

            // Collections save hooks removed

            function attachResolutionListeners() {
                const resolutionRadios = document.querySelectorAll('input[name="resolution"]');
                resolutionRadios.forEach(radio => {
                    radio.onclick = function() {
                        const selectedRes = parseInt(this.value);
                        console.log('Resolution radio clicked:', selectedRes);
                        if (window.planet) {
                            window.planet.resolution = selectedRes;
                            if (typeof window.planet.regenerate === 'function') {
                                window.planet.regenerate();
                                console.log('Called planet.regenerate()');
                            }
                        } else {
                            console.log('window.planet not found');
                        }
                    };
                });
            }

            closeSettings.addEventListener('click', () => {
                settingsModal.style.display = 'none';
            });

            // Close settings when clicking outside the modal
            settingsModal.addEventListener('click', (e) => {
                if (e.target === settingsModal) {
                    settingsModal.style.display = 'none';
                }
            });
        </script>

        <style>
            .graphics-section {
                margin-top: 25px;
                padding: 10px 0;
                border-top: 1px solid var(--neon-cyan);
            }
            .graphics-toggle-btn {
                width: 100%;
                background: transparent;
                border: none;
                outline: none;
                color: var(--neon-cyan);
                font-family: 'Share Tech Mono', monospace;
                font-size: 1.2rem;
                padding: 10px 0;
                text-align: left;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 8px;
                border-bottom: 1px solid var(--neon-cyan);
                transition: background 0.2s, color 0.2s;
            }
            .graphics-toggle-btn:hover {
                background: rgba(0,255,255,0.08);
                color: #fff;
            }
            .arrow {
                font-size: 1.1em;
                transition: transform 0.2s;
            }
            .graphics-section h3 {
                margin: 0 0 10px 0;
                font-size: 1.2rem;
                color: var(--neon-cyan);
            }
            .resolution-options {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }
            /* Audio/Volume section */
            .audio-section {
                margin-top: 20px;
                padding: 12px 0 0 0;
                border-top: 1px solid var(--neon-cyan);
            }
            .section-label {
                display: block;
                font-family: 'Share Tech Mono', monospace;
                font-size: 1.2rem;
                color: var(--neon-cyan);
                margin-bottom: 10px;
            }
            .volume-row {
                display: flex;
                align-items: center;
                gap: 12px;
            }
            #volume-slider {
                width: 100%;
                accent-color: var(--neon-cyan);
            }
            #volume-value {
                min-width: 44px;
                text-align: right;
                color: var(--neon-cyan);
                font-family: 'Share Tech Mono', monospace;
            }
            .resolution-options label {
                font-family: 'Share Tech Mono', monospace;
                color: var(--neon-cyan);
                font-size: 1rem;
                cursor: pointer;
                transition: color 0.2s;
            }
            .resolution-options input[type="radio"] {
                accent-color: var(--neon-cyan);
                margin-right: 10px;
            }
            .resolution-options label:hover {
                color: #fff;
            }
#alien-chat-box {
    position: fixed;
    left: 50%;
    bottom: 36px;
    transform: translateX(-50%);
    min-width: 320px;
    max-width: 90vw;
    width: 36vw;
    min-height: 140px;
    max-height: 60vh;
    background: rgba(0,0,0,0.85);
    border: 2px solid var(--neon-cyan, #00ffff);
    border-radius: 18px;
    box-shadow: 0 0 16px #00fff9, 0 0 2px #00fff9;
    z-index: 3000;
    display: flex;
    flex-direction: column;
    font-family: 'Share Tech Mono', monospace;
    color: var(--neon-cyan);
    /* Let content scroll but prevent native corner resize to avoid conflicts */
    overflow: hidden;
    position: fixed;
}

/* Chat drag & resize handles */
#alien-chat-box { position: fixed; }
#alien-chat-drag {
    position: absolute;
    top: 6px;
    left: 50%;
    transform: translateX(-50%);
    width: 100%;
    height: 18px;
    border-radius: 6px;
    background: rgba(0,255,255,0.2);
    box-shadow: 0 0 6px rgba(0,255,255,0.6);
    cursor: ns-resize; /* vertical resize */
    pointer-events: auto;
    z-index: 3100;
    touch-action: none; /* allow custom touch drag without scrolling */
}
#alien-chat-resizer { display: none; }
#alien-chat-messages {
    flex: 1 1 auto;
    min-height: 60px;
    overflow-y: auto;
    overflow-x: hidden;
    padding: 22px 18px 6px 18px;
    font-size: 1.05rem;
    display: flex;
    flex-direction: column;
    gap: 8px;
    /* Override any earlier max-height so only this area scrolls */
    max-height: none;
}
#alien-chat-input-row {
    display: flex;
    border-top: 1px solid var(--neon-cyan, #00ffff);
    padding: 10px 12px;
    align-items: center;
    background: rgba(0,255,255,0.05);
    border-radius: 0 0 16px 16px;
    /* Keep input row fixed in height; prevent shrinking when messages overflow */
    flex-shrink: 0;
}
#alien-chat-input {
    flex: 1;
    background: transparent;
    border: none;
    outline: none;
    color: #fff;
    font-size: 1.1rem;
    padding: 8px 10px;
    border-radius: 8px;
    margin-right: 8px;
    border: 1.5px solid var(--neon-cyan, #00ffff);
    transition: border 0.2s;
}
#alien-chat-input:focus {
    border: 1.5px solid #fff;
}
#alien-chat-send {
    background: var(--neon-cyan, #00ffff);
    color: #000;
    border: none;
    border-radius: 8px;
    font-size: 1.1rem;
    font-family: 'Share Tech Mono', monospace;
    padding: 8px 18px;
    cursor: pointer;
    transition: background 0.2s, color 0.2s;
    box-shadow: 0 0 8px #00fff9;
}
#alien-chat-send:hover {
    background: #fff;
    color: var(--neon-cyan, #00ffff);
}

#planetNameTop {
    position: fixed;
    top: 24px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 2000;
    color: var(--neon-cyan, #00ffff);
    font-family: 'Share Tech Mono', monospace;
    font-size: 1.2rem;
    letter-spacing: 2px;
    text-shadow: 0 0 8px #00fff9, 0 0 2px #00fff9;
    pointer-events: none;
    /* Removed background, border, border-radius, box-shadow, padding */
}
#infoBoxHolder, #infoBox, #instructions, #newPlanetButtonHolder, #brandTag, #line, #infoBoxHolderMobile, #planetNameMobile {
    display: none !important;
}

/* Responsive/mobile tweaks for alien chat */
@media (max-width: 900px) {
  #alien-chat-box {
    width: 72vw;
    max-width: 95vw;
    max-height: 56vh;
    bottom: 24px;
    border-radius: 16px;
  }
  #alien-chat-messages {
    font-size: 1rem;
  }
}

@media (max-width: 600px) {
  #alien-chat-box {
    left: 50%;
    transform: translateX(-50%);
    width: 94vw;
    max-width: 94vw;
    min-width: 0;
    bottom: 16px;
    max-height: 52vh;
    border-radius: 14px;
  }
  #alien-chat-drag {
    width: 60%;
    height: 16px;
  }
  #alien-chat-messages {
    padding: 12px 12px 6px 12px;
    font-size: 0.98rem;
    -webkit-overflow-scrolling: touch;
    min-height: 72px;
  }
  #alien-chat-input-row {
    padding: 12px;
    gap: 8px;
  }
  #alien-chat-input {
    font-size: 1rem;
    min-height: 44px; /* comfortable touch target */
    padding: 10px 12px;
  }
  #alien-chat-send {
    font-size: 1rem;
    min-height: 44px; /* comfortable touch target */
    min-width: 68px;
    padding: 0 14px;
  }
}
        </style>
        <div id="main-menu">
            <div class="geometric-overlay"></div>
            <div class="menu-content">
                <h1 class="title">Stranger Planets</h1>
                <button id="start-exploration" class="menu-button">Start Exploration</button>
                <button id="settings" class="menu-button">Settings</button>
            </div>
        </div>

        <!-- Application -->
        
    <script>
async function sendToOpenRouter(userMessage) {
    const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer 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",
            "HTTP-Referer": "http://localhost:3000",
            "X-Title": "ProceduralPlanet"
        },
        body: JSON.stringify({
            model: "meta-llama/llama-3.2-3b-instruct",
            messages: [
                { role: "system", content: "You are a concise alien. Reply in 1 short sentence (max 20 words). Avoid emojis and filler." },
                { role: "user", content: userMessage }
            ],
            max_tokens: 60,
            temperature: 0.7
        })
    });

    if (!response.ok) {
        throw new Error("OpenRouter API error: " + response.statusText);
    }
    const data = await response.json();
    let text = (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) || "";
    // Client-side brevity enforcement: keep to ~1 sentence / ~140 chars
    if (text.length > 180) text = text.slice(0, 180);
    const periodIdx = text.indexOf('.')
    if (periodIdx > 0) text = text.slice(0, periodIdx + 1);
    return text.trim();
}

function updatePlanetNameTop(name, iq) {
    var el = document.getElementById('planetNameTop');
    if (el) {
        el.innerHTML = '<div style="display:block;">' + name + '</div><div style="display:block; margin-top:0.5em; font-size:0.95em; letter-spacing:1.2px; color: var(--neon-cyan, #00ffff); text-shadow: 0 0 4px #00fff9;">iq: ' + iq + '</div>';
    }
}

window.addEventListener('DOMContentLoaded', function() {
    // Block FOV scroll when hovering chat box
    const chatBox = document.getElementById('alien-chat-box');
    let chatHover = false;
    if (chatBox) {
        chatBox.addEventListener('mouseenter', () => { chatHover = true; });
        chatBox.addEventListener('mouseleave', () => { chatHover = false; });
        chatBox.addEventListener('wheel', e => {
            // Always prevent FOV scroll when hovering chat box
            e.stopPropagation();
            // Do NOT call preventDefault; allow chat box to scroll naturally
        }, { passive: false });
    }
    // Intercept global wheel for FOV
    window.addEventListener('wheel', function(e) {
        if (chatHover) {
            // If hovering chat, do NOT change FOV (chat scrolls only)
            return;
        }
        // FOV scroll logic (must match your AbstractApplication.js logic)
        // Only adjust FOV if zoom is disabled
        if (window.camera && window.gui && window.camera.fov) {
            let delta = e.deltaY > 0 ? 2 : -2;
            window.camera.fov = Math.max(20, Math.min(120, window.camera.fov + delta));
            window.camera.updateProjectionMatrix();
            if (window.gui.__folders && window.gui.__folders.Camera && window.gui.__folders.Camera.__controllers) {
                let fovCtrl = window.gui.__folders.Camera.__controllers.find(c => c.property === 'fov');
                if (fovCtrl) fovCtrl.setValue(window.camera.fov);
            }
        }
    }, { passive: false });

    const chatInput = document.getElementById('alien-chat-input');
    const chatSend = document.getElementById('alien-chat-send');
    const chatMessages = document.getElementById('alien-chat-messages');
    const chatBoxEl = document.getElementById('alien-chat-box');
    const chatDrag = document.getElementById('alien-chat-drag');
    const chatResizer = document.getElementById('alien-chat-resizer');

    if (!chatInput || !chatSend || !chatMessages) return;

    // --- Resize only from the top (extend upwards), keep bottom anchored ---
    if (chatDrag && chatBoxEl) {
        let resizingTop = false;
        let startY = 0, startH = 0;

        const onMove = (clientY) => {
            const dy = startY - clientY; // moving up increases height
            const minH = 120;
            const maxH = Math.min(window.innerHeight - 20, 9000);
            const newH = Math.min(Math.max(minH, startH + dy), maxH);
            chatBoxEl.style.height = newH + 'px';
        };
        const endResize = () => {
            if (!resizingTop) return;
            resizingTop = false;
            document.body.style.userSelect = '';
        };

        // Mouse support
        chatDrag.addEventListener('mousedown', (e) => {
            resizingTop = true;
            const rect = chatBoxEl.getBoundingClientRect();
            startY = e.clientY;
            startH = rect.height;
            document.body.style.userSelect = 'none';
            e.preventDefault();
        }, { passive: false });
        document.addEventListener('mousemove', (e) => {
            if (!resizingTop) return;
            onMove(e.clientY);
        }, { passive: false });
        document.addEventListener('mouseup', endResize, { passive: true });

        // Touch support
        chatDrag.addEventListener('touchstart', (e) => {
            if (!e.touches || e.touches.length !== 1) return;
            resizingTop = true;
            const rect = chatBoxEl.getBoundingClientRect();
            startY = e.touches[0].clientY;
            startH = rect.height;
            document.body.style.userSelect = 'none';
            e.preventDefault(); // stop page scroll
        }, { passive: false });
        document.addEventListener('touchmove', (e) => {
            if (!resizingTop || !e.touches || e.touches.length !== 1) return;
            onMove(e.touches[0].clientY);
            e.preventDefault(); // stop page scroll while resizing
        }, { passive: false });
        document.addEventListener('touchend', endResize, { passive: true });
    }

    chatSend.onclick = async () => {
        const msg = chatInput.value.trim();
        if (!msg) return;
        chatInput.value = '';
        // Show user message
        const userDiv = document.createElement('div');
        userDiv.textContent = 'You: ' + msg;
        userDiv.style.color = '#fff';
        chatMessages.appendChild(userDiv);

        // Show loading...
        const alienDiv = document.createElement('div');
        alienDiv.textContent = 'Alien is typing...';
        alienDiv.style.color = 'var(--neon-cyan, #00ffff)';
        chatMessages.appendChild(alienDiv);

        try {
            const reply = await sendToOpenRouter(msg);
            alienDiv.textContent = 'Alien: ' + reply;
        } catch (err) {
            alienDiv.textContent = 'Alien: [Error: ' + err.message + ']';
        }
        chatMessages.scrollTop = chatMessages.scrollHeight;
    };
    chatInput.addEventListener('keydown', e => {
        if (e.key === 'Enter') chatSend.onclick();
    });
});
</script>

<script>
// --- Background Music Player ---
(function(){
  const musicPlaylist = [
    "https://cdn.pixabay.com/audio/2025/05/29/audio_15dbd53298.mp3",
    "https://cdn.pixabay.com/audio/2024/02/14/audio_b9bc3934cc.mp3",
    "https://cdn.pixabay.com/audio/2025/03/11/audio_03e017e1e5.mp3",
    "https://cdn.pixabay.com/audio/2025/06/24/audio_4c4a19ebef.mp3"
  ];
  let currentTrack = 0;
  let musicAudio = new Audio();
  // Expose globally for settings control
  window.musicAudio = musicAudio;
  // Initialize volume from localStorage if present
  const savedVol = parseFloat(localStorage.getItem('gameVolume'));
  musicAudio.volume = (!isNaN(savedVol) ? savedVol : 0.25);
  musicAudio.preload = 'auto';
  musicAudio.src = musicPlaylist[currentTrack];
  musicAudio.loop = false;
  musicAudio.autoplay = true;
  musicAudio.addEventListener('ended', () => {
    currentTrack = (currentTrack + 1) % musicPlaylist.length;
    musicAudio.src = musicPlaylist[currentTrack];
    musicAudio.play().catch(()=>{});
  });
  function tryPlay() {
    musicAudio.play().catch(() => {/* Autoplay blocked, do nothing */});
  }
  window.addEventListener('DOMContentLoaded', tryPlay);
  window.addEventListener('click', function(){
    if (musicAudio.paused) tryPlay();
  }, {once:true});
})();
</script>
</body>
</html>
